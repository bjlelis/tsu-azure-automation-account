# Laboratório 1 - Azure Automation Account

## Ligar e desligar uma VM no horário comercial

**Objetivo:**  
Manter uma VM ligada das 07:30 às 18:30 e desligada no restante do tempo, de forma automática e confiável.

---

## Sumário
- [Pré-requisitos](#pré-requisitos)
- [Arquitetura](#arquitetura)
- [Passo a passo](#passo-a-passo)
  - [1. Criar Resource Group](#1-criar-um-resource-group)
  - [2. Criar Automation Account](#2-criar-a-automation-account)
  - [3. Conceder RBAC mínimo](#3-conceder-rbac-mínimo-à-managed-identity)
  - [4. Criar Automation Variables](#4-criar-automation-variables)
  - [5. Criar Runbooks](#5-criar-runbooks)
    - [Start-VM.ps1](#a-start-vmps1)
    - [Stop-VM.ps1](#b-stop-vmps1)
  - [6. Criar Schedules](#6-criar-schedules)
  - [7. Vincular Schedules aos Runbooks](#7-vincular-schedules-aos-runbooks)
  - [8. Testes e validação](#8-testes-e-validação)
  - [9. Limpeza do ambiente](#9-limpeza-do-ambiente)
- [Conclusão](#conclusão)

---

## Pré-requisitos
1. Conta no Azure com permissão para criar recursos (RG, Automation Account, RBAC).  
2. Uma VM no Azure (use o tier mais barato para testes).  
3. Recomenda-se criar tudo em um Resource Group de laboratório para facilitar a limpeza depois.  

---

## Arquitetura
O que iremos usar para executar a tarefa:

1. Automation Account com Managed Identity (System Assigned).  
2. RBAC: a identidade gerenciada recebe **Virtual Machine Contributor** no escopo da VM.  
3. Runbooks PowerShell (7.2): `Start-VM.ps1` e `Stop-VM.ps1`.  
4. Schedules:  
   - **07:30** → executa `Start-VM`.  
   - **18:30** → executa `Stop-VM`.  
   - Fuso horário: **São Paulo (UTC-03:00)**.  

---

## Passo a passo

### 1. Criar um Resource Group
Pelo portal ou CLI.

---

### 2. Criar a Automation Account
Portal do Azure → Create a resource → Automation → Automation Account

- Nome: `aa-lab-startstop`  
- Resource Group: seu RG  
- Region: a mesma da VM  
- Identity: habilite **System assigned**  
- Networking: mantenha **public access**  
- Tags: `env:lab` (opcional, mas recomendado)  

---

### 3. Conceder RBAC mínimo à Managed Identity
Portal → VM alvo → **Access control (IAM)** → **Add role assignment**

- Role: **Virtual Machine Contributor**  
- Assign access to: **User, group, or service principal**  
- Select members: escolha a **Managed Identity** do Automation Account  
- Salve  

---

### 4. Criar Automation Variables
Na **Automation Account → Shared Resources → Variables → Add a variable**:

- `SubscriptionId` (string) → valor da sua subscription  
- `ResourceGroupName` (string) → nome do RG da VM  
- `VmName` (string) → nome da VM  

---

## 5. Criar Runbooks

### A) Start-VM.ps1
Portal → Automation Account → **Process Automation → Runbooks → Create a runbook**

- Nome: `start-vm`  
- Tipo: **PowerShell**  
- Runtime: **PowerShell 7.2**  
- Tags: `env:lab`  

```powershell
param([object]$WebhookData)
$ErrorActionPreference = 'Stop'

function Assert-Var($name, $value) {
  if ([string]::IsNullOrWhiteSpace([string]$value)) {
    throw "A variável de Automation '$name' está vazia ou ausente."
  }
}

# Variáveis (sanitizadas)
$SubscriptionIdRaw    = Get-AutomationVariable -Name 'SubscriptionId'
$ResourceGroupNameRaw = Get-AutomationVariable -Name 'ResourceGroupName'
$VmNameRaw            = Get-AutomationVariable -Name 'VmName'

Assert-Var 'SubscriptionId'    $SubscriptionIdRaw
Assert-Var 'ResourceGroupName' $ResourceGroupNameRaw
Assert-Var 'VmName'            $VmNameRaw

$SubscriptionId    = ($SubscriptionIdRaw -replace '[\r\n]', '').Trim()
$ResourceGroupName = ($ResourceGroupNameRaw -replace '[\r\n]', '').Trim()
$VmName            = ($VmNameRaw -replace '[\r\n]', '').Trim()

try { [void][Guid]::Parse($SubscriptionId) } catch { throw "SubscriptionId inválido: '$SubscriptionIdRaw'" }

Write-Output "Start-VM | Sub: $SubscriptionId | RG: $ResourceGroupName | VM: $VmName"

Connect-AzAccount -Identity | Out-Null

$vmId = "/subscriptions/$SubscriptionId/resourceGroups/$ResourceGroupName/providers/Microsoft.Compute/virtualMachines/$VmName"
$api = "2023-07-01"

# InstanceView
$ivResp = Invoke-AzRest -Path "$vmId/instanceView?api-version=$api" -Method GET
if ($ivResp.StatusCode -lt 200 -or $ivResp.StatusCode -ge 300) {
  throw "Falha ao obter instanceView. HTTP $($ivResp.StatusCode) $($ivResp.Content)"
}
$iv = $ivResp.Content | ConvertFrom-Json
$power = ($iv.statuses | Where-Object { $_.code -like 'PowerState/*' }).displayStatus
Write-Output "PowerState atual: $power"

if ($power -eq 'VM running') {
  Write-Output "Já está ligada. Nada a fazer."
  return
}

# Start VM
$resp = Invoke-AzRest -Path "$vmId/start?api-version=$api" -Method POST
if ($resp.StatusCode -lt 200 -or $resp.StatusCode -ge 300) {
  throw "Falha ao iniciar VM. HTTP $($resp.StatusCode) $($resp.Content)"
}
Write-Output "Start acionado (202/200)."
